{%extends "user/base.html" %}

{%block content%}
<h1>{{object.group_name}}</h1>
<div>
    <a href="{%url 'chats'%}">All chats</a>
</div>

<div id="chat-log">
    {%if sent_chats %}

        {%for message in sent_chats.reverse%}
            <ul>{{message.author}} : {{message.chat_message}}</ul>
        {%endfor%}

    {%else%}
        <ul>No message yet</ul>

    {%endif%}
    
    </div>
            <form action="" method="post" id="message-form">
                {%csrf_token%}
                {{form.as_p}}
                <button type="submit" id="#chat-message-submit'">Send</button>
            </form>
    <div>

</div>
{%endblock%}


{%block scripts%}
<!--need to access the pk of the curently selected group to-->
{{ object.pk|json_script:"room-name" }}
<script>
    const roomName = JSON.parse(document.getElementById('room-name').textContent);

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/chat/'
        + roomName
        + '/'
    );

    chatSocket.onmessage=function(e){
        const data = JSON.parse(e.data);
        document.querySelector('#chat-log').value += (data.message + '\n'); 
        console.log("success")    
        }

    chatSocket.onclose=function(e){
        console.error('Chat socket closed unexpectedly');
        console.error(e)
        }
    
    
</script>
{%endblock%}